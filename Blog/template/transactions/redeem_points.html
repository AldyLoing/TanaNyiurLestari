{% extends 'base.html' %}
{% load humanize %}

{% block content %}

<!-- Custom CSS -->
<style>
:root {
  --primary-blue: #4361ee;
  --secondary-purple: #7209b7;
  --accent-gold: #f2c94c;
  --light-bg: #f8f9ff;
  --dark-text: #2d3748;
  --success-green: #38b000;
  --warning-orange: #ff9e00;
}

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--light-bg);
  color: var(--dark-text);
}

.point-card {
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
  border-radius: 16px;
  box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
  color: white;
  border: none;
  overflow: hidden;
  position: relative;
  transition: all 0.3s ease;
}

.point-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(67, 97, 238, 0.3);
}

.point-card::before {
  content: "";
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(242,201,76,0.1) 0%, rgba(242,201,76,0) 70%);
  z-index: 0;
}

.point-card-content {
  position: relative;
  z-index: 1;
  padding: 2rem;
}

.coin-icon {
  font-size: 2.5rem;
  color: var(--accent-gold);
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}

.point-amount {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0.5rem 0;
}

.redeem-form-card {
  border-radius: 16px;
  border: none;
  box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  overflow: hidden;
  transition: all 0.3s ease;
}

.redeem-form-card:hover {
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.form-header {
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
  color: white;
  padding: 1rem;
}

.select-wrapper {
  position: relative;
}

.select-wrapper::after {
  content: "â–¼";
  font-size: 0.8rem;
  color: var(--primary-blue);
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.redeem-select {
  appearance: none;
  background-color: white;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  width: 100%;
  transition: all 0.3s ease;
}

.redeem-select:focus {
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
  outline: none;
}

.btn-redeem {
  background: linear-gradient(135deg, var(--accent-gold), #e8b020);
  border: none;
  border-radius: 10px;
  color: var(--dark-text);
  font-weight: 600;
  padding: 0.75rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(242, 201, 76, 0.3);
}

.btn-redeem:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(242, 201, 76, 0.4);
}

.btn-history {
  background: white;
  border: 2px solid var(--primary-blue);
  color: var(--primary-blue);
  border-radius: 10px;
  font-weight: 600;
  padding: 0.75rem 1.5rem;
  transition: all 0.3s ease;
}

.btn-history:hover {
  background: var(--primary-blue);
  color: white;
}

.alert-warning-custom {
  background-color: rgba(255, 158, 0, 0.1);
  border-left: 4px solid var(--warning-orange);
  color: var(--dark-text);
  border-radius: 8px;
}

.alert-success-custom {
  background-color: rgba(56, 176, 0, 0.1);
  border-left: 4px solid var(--success-green);
  color: var(--dark-text);
  border-radius: 8px;
}

.gift-illustration {
  max-width: 150px;
  margin: 0 auto;
  display: block;
}

@media (max-width: 768px) {
  .point-card-content {
    padding: 1.5rem;
  }
  
  .point-amount {
    font-size: 2rem;
  }
}
</style>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="fw-bold mb-3" style="color: var(--primary-blue);">Tukar Poin Hadiah</h1>
        <p class="lead">Gunakan poin Anda untuk mendapatkan hadiah menarik</p>
    </div>

    <!-- Point Balance Card -->
    <div class="point-card mb-4">
        <div class="point-card-content text-center">
            <i class="fas fa-coins coin-icon"></i>
            <h3 class="mb-2">Saldo Poin Anda</h3>
            <div class="point-amount" id="total-points">{{ total_points|intcomma }}</div>
            <p class="mb-0">Poin tersedia untuk ditukarkan</p>
        </div>
    </div>

    <!-- Low Balance Notification -->
    {% if total_points < 50 %}
        <div class="alert alert-warning-custom d-flex align-items-center mb-4">
            <i class="fas fa-exclamation-circle me-3" style="color: var(--warning-orange); font-size: 1.5rem;"></i>
            <div>
                <h5 class="fw-bold mb-1">Poin Anda hampir habis!</h5>
                <p class="mb-0">Anda membutuhkan minimal <strong>50 poin</strong> untuk melakukan penukaran.</p>
            </div>
        </div>
    {% endif %}

    <!-- Redemption Form -->
    <div class="redeem-form-card mb-4">
        <div class="form-header">
            <h4 class="mb-0"><i class="fas fa-gift me-2"></i> Form Penukaran Poin</h4>
        </div>
        <div class="p-4">
            <form method="POST" id="redeem-form">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="points" class="form-label fw-bold mb-3">Pilih jumlah poin yang ingin ditukar:</label>
                    <div class="select-wrapper">
                        <select name="points" class="redeem-select form-select" required>
                            {% if point_options %}
                                {% for option in point_options %}
                                    <option value="{{ option.points }}">
                                        {{ option.points|intcomma }} Poin = Rp {{ option.amount|intcomma }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option disabled>Tidak ada poin tersedia untuk ditukar</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-redeem w-100 py-3" {% if not point_options %}disabled{% endif %}>
                    <i class="fas fa-exchange-alt me-2"></i> Tukar Poin Sekarang
                </button>
            </form>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success-custom{% else %}alert-warning-custom{% endif %} d-flex align-items-center mb-4">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %} me-3" 
                   style="font-size: 1.5rem; color: {% if message.tags == 'success' %}var(--success-green){% else %}var(--warning-orange){% endif %}"></i>
                <div>
                    {{ message }}
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- History Button -->
    <div class="text-center mt-5">
        <a href="{% url 'redemption_history' %}" class="btn btn-history">
            <i class="fas fa-history me-2"></i> Lihat Riwayat Penukaran
        </a>
    </div>
</div>

<!-- Animation Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Floating coin animation
    const coin = document.querySelector('.coin-icon');
    
    // Balance update function
    function updateBalance() {
        fetch("{% url 'get_updated_balance' %}")
            .then(response => response.json())
            .then(data => {
                const pointElement = document.getElementById("total-points");
                // Add animation class
                pointElement.classList.add('text-success');
                // Format number with commas
                pointElement.textContent = data.user_points.toString().replace(/\B(?=(\d{3})+(?!\d)/g, ",");
                // Remove animation class after delay
                setTimeout(() => {
                    pointElement.classList.remove('text-success');
                }, 1000);
            })
            .catch(error => console.error("Error updating balance:", error));
    }

    // Update balance every 5 seconds
    setInterval(updateBalance, 5000);
    
    // Form submission animation
    const form = document.getElementById('redeem-form');
    if (form) {
        form.addEventListener('submit', function() {
            const button = this.querySelector('button[type="submit"]');
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Memproses...';
            button.disabled = true;
        });
    }
});
</script>

{% endblock %}